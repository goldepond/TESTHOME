import 'package:flutter/material.dart';
import '../../models/special_clause.dart';
import '../../constants/app_constants.dart';

class SmartClauseRecommendationScreen extends StatefulWidget {
  final Map<String, dynamic> propertyData;
  final Function(List<SpecialClause>) onClausesSelected;

  const SmartClauseRecommendationScreen({
    Key? key,
    required this.propertyData,
    required this.onClausesSelected,
  }) : super(key: key);

  @override
  State<SmartClauseRecommendationScreen> createState() => _SmartClauseRecommendationScreenState();
}

class _SmartClauseRecommendationScreenState extends State<SmartClauseRecommendationScreen> {
  List<SpecialClause> allClauses = [];
  List<SpecialClause> recommendedClauses = [];
  Map<String, bool> selectedClauses = {};
  Map<String, String> clauseTexts = {};

  @override
  void initState() {
    super.initState();
    _initializeClauses();
  }

  void _initializeClauses() {
    // Î™®Îì† ÌäπÏïΩ Í∞ÄÏ†∏Ïò§Í∏∞
    allClauses = SpecialClauseData.getDefaultClauses();
    
    // Ï∂îÏ≤ú ÌäπÏïΩ Í≥ÑÏÇ∞
    recommendedClauses = SpecialClauseData.getRecommendedClauses(
      maintenanceFee: widget.propertyData['maintenanceFee'] ?? 0.0,
      hasIndividualMetering: widget.propertyData['hasIndividualMetering'] ?? false,
      buildingType: widget.propertyData['buildingType'] ?? 'ÏùºÎ∞ò',
      hasJuniorMortgage: widget.propertyData['hasJuniorMortgage'] ?? false,
      buildingAge: widget.propertyData['buildingAge'] ?? 0,
      deposit: widget.propertyData['deposit'] ?? 0.0,
      leaseTerm: widget.propertyData['leaseTerm'] ?? 12,
      hasDefectHistory: widget.propertyData['hasDefectHistory'] ?? false,
      isNewBuilding: widget.propertyData['isNewBuilding'] ?? false,
    );

    // Í∏∞Î≥∏ ÏÑ†ÌÉù ÏÉÅÌÉú ÏÑ§Ï†ï
    for (final clause in allClauses) {
      selectedClauses[clause.id] = clause.isDefaultOn;
      clauseTexts[clause.id] = clause.defaultText;
    }
  }

  void _toggleClause(String clauseId) {
    setState(() {
      selectedClauses[clauseId] = !(selectedClauses[clauseId] ?? false);
    });
  }

  void _showReasonDialog(SpecialClause clause) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('${clause.title} - Ï∂îÏ≤ú Ïù¥Ïú†'),
        content: SingleChildScrollView(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'Ï∂îÏ≤ú Ïù¥Ïú†:',
                style: const TextStyle(fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 8),
              Text(clause.reason),
              const SizedBox(height: 16),
              Text(
                'Í∞ùÍ¥ÄÏ†Å Í∑ºÍ±∞:',
                style: const TextStyle(fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 8),
              Text(clause.objectiveBasis),
              if (clause.recommendationConditions.isNotEmpty) ...[
                const SizedBox(height: 16),
                Text(
                  'Ï∂îÏ≤ú Ï°∞Í±¥:',
                  style: const TextStyle(fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 8),
                ...clause.recommendationConditions.map((condition) => 
                  Padding(
                    padding: const EdgeInsets.only(left: 8, bottom: 4),
                    child: Row(
                      children: [
                        const Icon(Icons.check_circle, size: 16, color: Colors.green),
                        const SizedBox(width: 8),
                        Text('‚Ä¢ $condition'),
                      ],
                    ),
                  ),
                ),
              ],
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Îã´Í∏∞'),
          ),
        ],
      ),
    );
  }

  void _showAlternativesDialog(SpecialClause clause) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('${clause.title} - ÎåÄÏ≤¥Ïïà'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              'ÏûÑÎåÄÏù∏Ïù¥ Í±∞Ï†àÌï† Í≤ΩÏö∞ Ï†úÏïàÌï† Ïàò ÏûàÎäî ÎåÄÏ≤¥Ïïà:',
              style: const TextStyle(fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 16),
            ...clause.alternatives.map((alternative) => 
              Padding(
                padding: const EdgeInsets.only(bottom: 8),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text('‚Ä¢ ', style: TextStyle(fontWeight: FontWeight.bold)),
                    Expanded(child: Text(alternative)),
                  ],
                ),
              ),
            ),
            const SizedBox(height: 16),
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.blue.withValues(alpha:0.1),
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.blue.withValues(alpha:0.3)),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'üí° ÌòëÏÉÅ ÌåÅ:',
                    style: TextStyle(fontWeight: FontWeight.bold, color: Colors.blue),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    clause.objectiveBasis,
                    style: const TextStyle(fontSize: 12),
                  ),
                ],
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Îã´Í∏∞'),
          ),
        ],
      ),
    );
  }

  void _showTextEditDialog(SpecialClause clause) {
    final TextEditingController controller = TextEditingController(
      text: clauseTexts[clause.id] ?? clause.defaultText,
    );

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('${clause.title} - Î¨∏Íµ¨ ÏàòÏ†ï'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              'Í∏∞Î≥∏ Î¨∏Íµ¨ÏóêÏÑú ÎÇ†Ïßú¬∑Í∏∞Ìïú Îì± Î≥ÄÏàòÎßå ÏïàÏ†ÑÌïòÍ≤å Ìé∏ÏßëÌïòÏÑ∏Ïöî.',
              style: TextStyle(fontSize: 12, color: Colors.grey[600]),
            ),
            const SizedBox(height: 16),
            TextField(
              controller: controller,
              maxLines: 5,
              decoration: const InputDecoration(
                border: OutlineInputBorder(),
                hintText: 'ÌäπÏïΩ Î¨∏Íµ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
              ),
            ),
            if (clause.variables.isNotEmpty) ...[
              const SizedBox(height: 16),
              Text(
                'ÏàòÏ†ï Í∞ÄÎä•Ìïú Î≥ÄÏàò:',
                style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12),
              ),
              const SizedBox(height: 8),
              ...clause.variables.entries.map((entry) => 
                Padding(
                  padding: const EdgeInsets.only(bottom: 4),
                  child: Text(
                    '‚Ä¢ ${entry.key}: ${entry.value}',
                    style: const TextStyle(fontSize: 12, color: Colors.grey),
                  ),
                ),
              ),
            ],
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Ï∑®ÏÜå'),
          ),
          ElevatedButton(
            onPressed: () {
              setState(() {
                clauseTexts[clause.id] = controller.text;
              });
              Navigator.of(context).pop();
            },
            child: const Text('Ï†ÄÏû•'),
          ),
        ],
      ),
    );
  }

  Widget _buildClauseCard(SpecialClause clause) {
    final isSelected = selectedClauses[clause.id] ?? false;
    final isRecommended = recommendedClauses.contains(clause);
    final isDefaultOn = clause.isDefaultOn;

    return Card(
      margin: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),
      elevation: 2,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Ìó§Îçî
            Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Text(
                            clause.title,
                            style: const TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          if (isDefaultOn) ...[
                            const SizedBox(width: 8),
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                              decoration: BoxDecoration(
                                color: Colors.red,
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: const Text(
                                'Í∏∞Î≥∏',
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: 10,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ),
                          ],
                          if (isRecommended) ...[
                            const SizedBox(width: 8),
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                              decoration: BoxDecoration(
                                color: Colors.blue,
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: const Text(
                                'Ï∂îÏ≤úÎê®',
                                style: TextStyle(
                                  color: Colors.white,
                                  fontSize: 10,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                            ),
                          ],
                        ],
                      ),
                      const SizedBox(height: 4),
                      Text(
                        clause.description,
                        style: TextStyle(
                          fontSize: 14,
                          color: Colors.grey[600],
                        ),
                      ),
                    ],
                  ),
                ),
                // ÌÜ†Í∏Ä Ïä§ÏúÑÏπò
                Column(
                  children: [
                    Switch(
                      value: isSelected,
                      onChanged: (value) => _toggleClause(clause.id),
                      activeThumbColor: AppColors.kBrown,
                    ),
                    Text(
                      isSelected ? 'ON' : 'OFF',
                      style: TextStyle(
                        fontSize: 12,
                        color: isSelected ? Colors.green : Colors.grey,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ],
                ),
              ],
            ),
            
            // Ïï°ÏÖò Î≤ÑÌäºÎì§
            const SizedBox(height: 12),
            Row(
              children: [
                Expanded(
                  child: OutlinedButton.icon(
                    onPressed: () => _showReasonDialog(clause),
                    icon: const Icon(Icons.info_outline, size: 16),
                    label: const Text('Ïôú Ï∂îÏ≤úÎêêÎÇòÏöî?'),
                    style: OutlinedButton.styleFrom(
                      foregroundColor: Colors.blue,
                      side: const BorderSide(color: Colors.blue),
                      padding: const EdgeInsets.symmetric(vertical: 8),
                    ),
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: OutlinedButton.icon(
                    onPressed: () => _showAlternativesDialog(clause),
                    icon: const Icon(Icons.help_outline, size: 16),
                    label: const Text('ÎåÄÏ≤¥Ïïà'),
                    style: OutlinedButton.styleFrom(
                      foregroundColor: Colors.orange,
                      side: const BorderSide(color: Colors.orange),
                      padding: const EdgeInsets.symmetric(vertical: 8),
                    ),
                  ),
                ),
                const SizedBox(width: 8),
                Expanded(
                  child: OutlinedButton.icon(
                    onPressed: () => _showTextEditDialog(clause),
                    icon: const Icon(Icons.edit, size: 16),
                    label: const Text('Î¨∏Íµ¨ ÏàòÏ†ï'),
                    style: OutlinedButton.styleFrom(
                      foregroundColor: Colors.green,
                      side: const BorderSide(color: Colors.green),
                      padding: const EdgeInsets.symmetric(vertical: 8),
                    ),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final selectedCount = selectedClauses.values.where((selected) => selected).length;
    final totalCount = allClauses.length;

    return Scaffold(
      appBar: AppBar(
        title: const Text('Ïä§ÎßàÌä∏ ÌäπÏïΩ Ï∂îÏ≤ú'),
        backgroundColor: AppColors.kBrown,
        foregroundColor: Colors.white,
      ),
      body: Column(
        children: [
          // ÏÉÅÎã® ÏïàÎÇ¥
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            color: Colors.blue.withValues(alpha:0.1),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: const [
                    Icon(Icons.lightbulb, color: Colors.blue),
                    SizedBox(width: 8),
                    Text(
                      'Ï∂îÏ≤ú ÌäπÏïΩ',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: Colors.blue,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Text(
                  'Í≥ÑÏïΩÏÑúÏóê Íº≠ ÎÑ£Ïñ¥Ïïº Ìï† Î≥¥Ìò∏ ÌäπÏïΩÏùÑ ÏûêÎèô Ï∂îÏ≤úÌï¥ÎìúÎ¶ΩÎãàÎã§.',
                  style: TextStyle(fontSize: 14, color: Colors.grey[700]),
                ),
                const SizedBox(height: 8),
                Text(
                  'ÏÑ†ÌÉùÎêú ÌäπÏïΩ: $selectedCount/$totalCountÍ∞ú',
                  style: const TextStyle(fontWeight: FontWeight.bold),
                ),
              ],
            ),
          ),
          
          // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Î™©Î°ù
          Expanded(
            child: ListView.builder(
              padding: const EdgeInsets.symmetric(vertical: 8),
              itemCount: allClauses.length,
              itemBuilder: (context, index) {
                return _buildClauseCard(allClauses[index]);
              },
            ),
          ),
          
          // ÌïòÎã® Î≤ÑÌäºÎì§
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              boxShadow: [
                BoxShadow(
                  color: Colors.grey.withValues(alpha:0.2),
                  spreadRadius: 1,
                  blurRadius: 3,
                  offset: const Offset(0, -1),
                ),
              ],
            ),
            child: Column(
              children: [
                Row(
                  children: [
                    Expanded(
                      child: OutlinedButton(
                        onPressed: () {
                          // Î™®Îì† ÌäπÏïΩ ÏÑ†ÌÉù Ìï¥Ï†ú
                          setState(() {
                            for (final clause in allClauses) {
                              selectedClauses[clause.id] = false;
                            }
                          });
                        },
                        style: OutlinedButton.styleFrom(
                          foregroundColor: Colors.red,
                          side: const BorderSide(color: Colors.red),
                          padding: const EdgeInsets.symmetric(vertical: 12),
                        ),
                        child: const Text('Î™®Îëê Ìï¥Ï†ú'),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () {
                          // ÏÑ†ÌÉùÎêú ÌäπÏïΩÎì§ÏùÑ Í≥ÑÏïΩÏÑúÏóê Ï∂îÍ∞Ä
                          final selectedClauseList = allClauses
                              .where((clause) => selectedClauses[clause.id] ?? false)
                              .map((clause) => clause.copyWith(
                                    defaultText: clauseTexts[clause.id] ?? clause.defaultText,
                                  ))
                              .toList();
                          
                          widget.onClausesSelected(selectedClauseList);
                          Navigator.of(context).pop();
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: AppColors.kBrown,
                          foregroundColor: Colors.white,
                          padding: const EdgeInsets.symmetric(vertical: 12),
                        ),
                        child: const Text('Í≥ÑÏïΩÏÑúÏóê Ï∂îÍ∞Ä'),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Text(
                  'Í∏∞Î≥∏ ON ÏÉÅÌÉúÏùò ÌäπÏïΩÏùÄ ÏûÑÏ∞®Ïù∏ Î≥¥Ìò∏Ïóê Í∞ÄÏû• Ï§ëÏöîÌïú Ï°∞Ìï≠ÏûÖÎãàÎã§.',
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey[600],
                  ),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

